# $Id: INSTALL,v 3.3 2000/08/01 12:10:06 ksb Exp $

Prereq
------

You need mkcmd.  You need at least mkcmd 8.13.  Get it from the
same FTP site you got this from.   You could really use "install",
the ksb version.   You must know how to build "master source" tools
(get "msrc0" if you don't).


Install
-------

You need to make the login `charon' with primary group `charon'.  This is
the tomb owner.  Things setuid (setgid) charon can read/write the crypts
for any login.

/etc/passwd
	charon:*:11520:602:The Ferryman:/home/dscm1/Tomb:/nonexistant
/etc/group
	charon:*:602:

If you make the login have uid #11520 and the group #602 you won't have to
change them in libtomb/libtomb.h.  Else change them there (now).

If you are going to install entombing under /usr/local/{bin,lib,etc} then
you won't have to change the path to entomb in libtomb/libtomb.h, else
change it there.

On about line 80 of libtomb/libtomb.h we try to guess how to read the
mounted file systems list.  The -D`hostype' in all the Makefile's tells us
which one to pick (SUN3, SUN4, S81 (Dynix), ...).

Type in "makeme" or if you have msrc setup "make HOSTS=-m... all"
and see if it all builds. On Solaris you might get:
	"eopen.c", line 39: warning: identifier redeclared: open
	"eopen.c", line 41: warning: type does not match prototype: file
	"eopen.c", line 41: warning: parameter mismatch: 2 declared, 3 defined


[Follow local msrc custom here]
Then as root run (this will install all the parts)
	# make HOSTS=-mXXX install
or cd into each directory and run
	# make HOSTS=-mXXX INTO=/YYY -n install
to see what we install.  (If you have PUCC install it will work best.)

You can entomb things with
	/usr/local/lib/entomb -C file

Put the system startup for "preend" in /etc/init.d/preend and link it,
or in /usr/local/etc/rc.d as preend.sh (it is "etc/preend/preend.sh" now).
Or on older systems edit /etc/rc.local and put in the local daemons:
	if [ -x /usr/local/etc/preend ] ; then
		echo -n " preend" ; /usr/local/etc/preend -p
	fi


To make rm/mv/cp entomb get the Net2 source to them and build them
with /usr/local/lib/libtomb.a on the load line.  [The package "rm-1.0.tgz"
has the source you need.]  On a FreeBSD host you can
	cd /usr/src/bin/rm
	make "LDADD=-L/usr/local/lib -ltomb" clean rm install
	cd ../mv
	make "LDADD=-L/usr/local/lib -ltomb" clean mv install
	cd ../cp
	make "LDADD=-L/usr/local/lib -ltomb" clean cp install


To test it.
-----------

Try to start preends on a filesystem you can write on (as root)
do NOT pick "/" or "/tmp":
	#  /usr/local/etc/preend -d /var
	preend: build tomb with `install -d -m 0770 -o charon -g charon /var/Tomb'

Note that preend tells you how to use install to construct the tomb, do it:
	# install -d -m 0770 -o charon -g charon /var/Tomb

Then make preend run:
	# /usr/local/etc/preend -d /var &
	preend: Cleaning /var/Tomb
	preend: sleeping 5 minutes
	#

In another window create a test file on the target filesystem, as some
non-superuser (like "daemon"):
	daemon$  cd /var/msgs
	daemon$  date > tfile
	daemon$  rm tfile
	daemon$  unrm -l
	Files entombed for you:  (most recently removed first)
		  date entombed  file name                  file size
		  ---- --------  ---- ----                  ---- ----
	Mon Jul 31 15:27:37 2000  tfile                     29


If that looks OK, you can remove the (bogus) tomb you created.
And stop the debug version of preend.


Final tuning
------------

Now build tombs on each filesystem (e.g. /home/$fs/Tomb) that Customers
might delete files they wanted from.  Do not EVER put a Tomb on
slash (/) or the system temporary directories (/tmp, /var/tmp).

In the system startup you need to add "preend" to purge the crypts
of old files.  See etc/preend/README and such.  Then reboot, or
start the system script for preend by hand (from the console, maybe).


Disclaimer:
-----------

FedEx takes no comfort or distress from the fact that I did this work all
on my own time.  Neither of us expect that this software will bring us
material gain or blame.  Use at your own risk.


--
kayessbe, On his own, ksb@sa.fedex.com, July 2000
